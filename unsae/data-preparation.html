<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Data preparation | Ghana Unit Level Modeling Document</title>
  <meta name="description" content="3 Data preparation | Ghana Unit Level Modeling Document" />
  <meta name="generator" content="bookdown 0.30 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Data preparation | Ghana Unit Level Modeling Document" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Data preparation | Ghana Unit Level Modeling Document" />
  
  
  

<meta name="author" content="YD Hwang" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="spatial-data-loading.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="preamble.html"><a href="preamble.html"><i class="fa fa-check"></i><b>1</b> Preamble</a>
<ul>
<li class="chapter" data-level="1.1" data-path="preamble.html"><a href="preamble.html#r-packages"><i class="fa fa-check"></i><b>1.1</b> R packages</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#unsae-package"><i class="fa fa-check"></i><b>2.2</b> <code>unsae</code> package</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-preparation.html"><a href="data-preparation.html"><i class="fa fa-check"></i><b>3</b> Data preparation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-preparation.html"><a href="data-preparation.html#description"><i class="fa fa-check"></i><b>3.1</b> Description</a></li>
<li class="chapter" data-level="3.2" data-path="data-preparation.html"><a href="data-preparation.html#dhs-data-loading"><i class="fa fa-check"></i><b>3.2</b> DHS Data loading</a></li>
<li class="chapter" data-level="3.3" data-path="data-preparation.html"><a href="data-preparation.html#individual-level-data-handling"><i class="fa fa-check"></i><b>3.3</b> Individual level data handling</a></li>
<li class="chapter" data-level="3.4" data-path="data-preparation.html"><a href="data-preparation.html#selection-of-the-variables-1"><i class="fa fa-check"></i><b>3.4</b> Selection of the variables (1)</a></li>
<li class="chapter" data-level="3.5" data-path="data-preparation.html"><a href="data-preparation.html#selection-of-the-variables-2"><i class="fa fa-check"></i><b>3.5</b> Selection of the variables (2)</a></li>
<li class="chapter" data-level="3.6" data-path="data-preparation.html"><a href="data-preparation.html#glimpse-of-the-data"><i class="fa fa-check"></i><b>3.6</b> Glimpse of the data</a></li>
<li class="chapter" data-level="3.7" data-path="data-preparation.html"><a href="data-preparation.html#household-level"><i class="fa fa-check"></i><b>3.7</b> Household level</a></li>
<li class="chapter" data-level="3.8" data-path="data-preparation.html"><a href="data-preparation.html#renaming"><i class="fa fa-check"></i><b>3.8</b> Renaming</a></li>
<li class="chapter" data-level="3.9" data-path="data-preparation.html"><a href="data-preparation.html#selection-of-the-variables-3"><i class="fa fa-check"></i><b>3.9</b> Selection of the variables (3)</a></li>
<li class="chapter" data-level="3.10" data-path="data-preparation.html"><a href="data-preparation.html#glimpse-of-the-data-1"><i class="fa fa-check"></i><b>3.10</b> Glimpse of the data</a></li>
<li class="chapter" data-level="3.11" data-path="data-preparation.html"><a href="data-preparation.html#joining-the-individual-and-household-data"><i class="fa fa-check"></i><b>3.11</b> Joining the individual and household data</a></li>
<li class="chapter" data-level="3.12" data-path="data-preparation.html"><a href="data-preparation.html#data-modification"><i class="fa fa-check"></i><b>3.12</b> Data modification</a></li>
<li class="chapter" data-level="3.13" data-path="data-preparation.html"><a href="data-preparation.html#conversion"><i class="fa fa-check"></i><b>3.13</b> Conversion</a></li>
<li class="chapter" data-level="3.14" data-path="data-preparation.html"><a href="data-preparation.html#defining-the-target-variables"><i class="fa fa-check"></i><b>3.14</b> Defining the target variables</a></li>
<li class="chapter" data-level="3.15" data-path="data-preparation.html"><a href="data-preparation.html#quick-screeing-of-key-variables"><i class="fa fa-check"></i><b>3.15</b> Quick screeing of key variables</a></li>
<li class="chapter" data-level="3.16" data-path="data-preparation.html"><a href="data-preparation.html#additional-steps-to-simplify-the-data-1"><i class="fa fa-check"></i><b>3.16</b> Additional steps to simplify the data (1)</a></li>
<li class="chapter" data-level="3.17" data-path="data-preparation.html"><a href="data-preparation.html#additional-steps-to-simplify-the-data-2"><i class="fa fa-check"></i><b>3.17</b> Additional steps to simplify the data (2)</a></li>
<li class="chapter" data-level="3.18" data-path="data-preparation.html"><a href="data-preparation.html#automatic-model-fitting"><i class="fa fa-check"></i><b>3.18</b> Automatic Model fitting</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spatial-data-loading.html"><a href="spatial-data-loading.html"><i class="fa fa-check"></i><b>4</b> Spatial data loading</a>
<ul>
<li class="chapter" data-level="4.1" data-path="spatial-data-loading.html"><a href="spatial-data-loading.html#spatial-data-preparation"><i class="fa fa-check"></i><b>4.1</b> Spatial data preparation</a></li>
<li class="chapter" data-level="4.2" data-path="spatial-data-loading.html"><a href="spatial-data-loading.html#important-notes"><i class="fa fa-check"></i><b>4.2</b> Important Notes</a></li>
<li class="chapter" data-level="4.3" data-path="spatial-data-loading.html"><a href="spatial-data-loading.html#map-image-tiles-downloading"><i class="fa fa-check"></i><b>4.3</b> Map image tiles downloading</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="model-fitting.html"><a href="model-fitting.html"><i class="fa fa-check"></i><b>5</b> Model fitting</a>
<ul>
<li class="chapter" data-level="5.1" data-path="model-fitting.html"><a href="model-fitting.html#description-1"><i class="fa fa-check"></i><b>5.1</b> Description</a></li>
<li class="chapter" data-level="5.2" data-path="model-fitting.html"><a href="model-fitting.html#cluster-wise-estimate-naive"><i class="fa fa-check"></i><b>5.2</b> Cluster-wise estimate (naive)</a></li>
<li class="chapter" data-level="5.3" data-path="model-fitting.html"><a href="model-fitting.html#removing-the-clusters-with-missing-coordinates"><i class="fa fa-check"></i><b>5.3</b> Removing the clusters with missing coordinates</a></li>
<li class="chapter" data-level="5.4" data-path="model-fitting.html"><a href="model-fitting.html#model-fitting-1"><i class="fa fa-check"></i><b>5.4</b> Model fitting</a></li>
<li class="chapter" data-level="5.5" data-path="model-fitting.html"><a href="model-fitting.html#small-area-model-fitting"><i class="fa fa-check"></i><b>5.5</b> Small area model fitting</a></li>
<li class="chapter" data-level="5.6" data-path="model-fitting.html"><a href="model-fitting.html#notes-on-multilevel_em"><i class="fa fa-check"></i><b>5.6</b> Notes on <code>multilevel_EM</code></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html"><i class="fa fa-check"></i><b>6</b> Preparing the admin shape file</a>
<ul>
<li class="chapter" data-level="6.1" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#raster-map"><i class="fa fa-check"></i><b>6.1</b> raster map</a></li>
<li class="chapter" data-level="6.2" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#what-we-will-do"><i class="fa fa-check"></i><b>6.2</b> What we will do:</a></li>
<li class="chapter" data-level="6.3" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#importing-the-shape-files"><i class="fa fa-check"></i><b>6.3</b> Importing the shape files</a></li>
<li class="chapter" data-level="6.4" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#creating-a-grid"><i class="fa fa-check"></i><b>6.4</b> Creating a grid</a></li>
<li class="chapter" data-level="6.5" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#prediction-based-on-resampling"><i class="fa fa-check"></i><b>6.5</b> Prediction based on resampling</a></li>
<li class="chapter" data-level="6.6" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#creating-a-grid-map"><i class="fa fa-check"></i><b>6.6</b> Creating a grid map</a></li>
<li class="chapter" data-level="6.7" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#calculation-for-each-grid"><i class="fa fa-check"></i><b>6.7</b> Calculation for each grid</a></li>
<li class="chapter" data-level="6.8" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#plotting"><i class="fa fa-check"></i><b>6.8</b> Plotting</a></li>
<li class="chapter" data-level="6.9" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#area-level-overview"><i class="fa fa-check"></i><b>6.9</b> Area level (overview)</a></li>
<li class="chapter" data-level="6.10" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#importing-the-shapefile"><i class="fa fa-check"></i><b>6.10</b> Importing the shapefile</a></li>
<li class="chapter" data-level="6.11" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#producing-the-prediction-grid"><i class="fa fa-check"></i><b>6.11</b> Producing the prediction grid</a></li>
<li class="chapter" data-level="6.12" data-path="preparing-the-admin-shape-file.html"><a href="preparing-the-admin-shape-file.html#creating-a-plot"><i class="fa fa-check"></i><b>6.12</b> Creating a plot</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Ghana Unit Level Modeling Document</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-preparation" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> Data preparation<a href="data-preparation.html#data-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="description" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Description<a href="data-preparation.html#description" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>This section illustrates the data preparation steps for the unit level model.</li>
<li>Throughout, we assume that the data files are stored in <code>../data/</code> (locations are all relative).</li>
<li>Alternatively, one can use <code>file.choose()</code> and locate the file manually.</li>
</ul>
</div>
<div id="dhs-data-loading" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> DHS Data loading<a href="data-preparation.html#dhs-data-loading" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Detailed description of DHS data can be found at <a href="https://dhsprogram.com/pubs/pdf/DHSG4/Recode7_DHS_10Sep2018_DHSG4.pdf">DHS site</a>.</li>
<li>DHS data files are assumed to be stored in <code>../data/2011 DHS/</code>.</li>
<li>For Ghana case,
<ul>
<li><code>GHHR72FL.SAV</code>: individual data</li>
<li><code>GHIR72FL.SAV</code>: Household data</li>
</ul></li>
<li>We use <code>haven::read_sav</code> function to read the data files stored in <code>SAV</code> format.</li>
</ul>
</div>
<div id="individual-level-data-handling" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Individual level data handling<a href="data-preparation.html#individual-level-data-handling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Artifact of converting SPSS <code>SAV</code> file to “flattened” data table form can be removed by choosing the variables that don’t have “$” in their names.</li>
<li>They are excluded from the analysis. In the code, it looks for <code>$</code> string and excludes them from the data set.</li>
</ul>
<blockquote>
<p>Multiple occurrence variables are placed one after the other by occurrence; all variables for occurrence 1 precede all variables for occurrence 2 and so on; multiple occurrence variables have a numeric sub- index that indicate the occurrence number.</p>
</blockquote>
</div>
<div id="selection-of-the-variables-1" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Selection of the variables (1)<a href="data-preparation.html#selection-of-the-variables-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>These information can be difficult to use, so removed from the analysis.</li>
<li><code>V003</code> is the Respondent’s line number in the household schedule, so removed from the analysis.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="data-preparation.html#cb4-1" aria-hidden="true" tabindex="-1"></a>indiv_ini <span class="ot">&lt;-</span> <span class="fu">read_sav</span>(<span class="st">&quot;../data/2011 DHS/GHIR72FL.SAV&quot;</span>)   </span>
<span id="cb4-2"><a href="data-preparation.html#cb4-2" aria-hidden="true" tabindex="-1"></a>indiv <span class="ot">&lt;-</span> indiv_ini <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">!</span><span class="fu">matches</span>(<span class="st">&quot;[</span><span class="sc">\\</span><span class="st">$]&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="data-preparation.html#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>V000) <span class="sc">%&gt;%</span> <span class="co"># same country </span></span>
<span id="cb4-4"><a href="data-preparation.html#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>V003) </span></code></pre></div>
</div>
<div id="selection-of-the-variables-2" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Selection of the variables (2)<a href="data-preparation.html#selection-of-the-variables-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="data-preparation.html#cb5-1" aria-hidden="true" tabindex="-1"></a>indiv <span class="ot">&lt;-</span> indiv <span class="sc">%&gt;%</span> <span class="fu">select_if</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">is.na</span>(x)) <span class="sc">&lt;</span> <span class="fl">0.3</span>)</span></code></pre></div>
<ul>
<li>For the purpose of SAE, the variables with too high missing rate are not useful. Hence we exclude those with less than 30 % missing.</li>
<li>We can see that 4079 columns are reduced to 405.</li>
<li>It’s important to notice that in the real world,
one should handle the missing variable problem one-by-one.</li>
</ul>
</div>
<div id="glimpse-of-the-data" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> Glimpse of the data<a href="data-preparation.html#glimpse-of-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>We can see the variable information here presented in Table label.</li>
<li>Only first few are presented here.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="data-preparation.html#cb6-1" aria-hidden="true" tabindex="-1"></a>info <span class="ot">&lt;-</span> <span class="fu">lapply</span>(indiv, <span class="cf">function</span>(x) <span class="fu">attr</span>(x, <span class="st">&quot;label&quot;</span>))</span>
<span id="cb6-2"><a href="data-preparation.html#cb6-2" aria-hidden="true" tabindex="-1"></a>ind_var_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">COL =</span> <span class="fu">names</span>(info), <span class="at">DESC =</span> <span class="fu">as.character</span>(info)) </span>
<span id="cb6-3"><a href="data-preparation.html#cb6-3" aria-hidden="true" tabindex="-1"></a>ind_var_tbl <span class="sc">%&gt;%</span> head <span class="sc">%&gt;%</span> pander</span></code></pre></div>
<table style="width:51%;">
<colgroup>
<col width="12%" />
<col width="38%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">COL</th>
<th align="center">DESC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">CASEID</td>
<td align="center">Case Identification</td>
</tr>
<tr class="even">
<td align="center">V001</td>
<td align="center">Cluster number</td>
</tr>
<tr class="odd">
<td align="center">V002</td>
<td align="center">Household number</td>
</tr>
<tr class="even">
<td align="center">V004</td>
<td align="center">Ultimate area unit</td>
</tr>
<tr class="odd">
<td align="center">V005</td>
<td align="center">Women’s individual sample
weight (6 decimals)</td>
</tr>
<tr class="even">
<td align="center">V006</td>
<td align="center">Month of interview</td>
</tr>
</tbody>
</table>
</div>
<div id="household-level" class="section level2 hasAnchor" number="3.7">
<h2><span class="header-section-number">3.7</span> Household level<a href="data-preparation.html#household-level" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We first conduct the data cleaning for household data in a similar manner.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="data-preparation.html#cb7-1" aria-hidden="true" tabindex="-1"></a>household_ini <span class="ot">&lt;-</span> <span class="fu">read_sav</span>(<span class="st">&quot;../data/2011 DHS/GHHR72FL.SAV&quot;</span>)</span>
<span id="cb7-2"><a href="data-preparation.html#cb7-2" aria-hidden="true" tabindex="-1"></a>household <span class="ot">&lt;-</span> household_ini <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">!</span><span class="fu">matches</span>(<span class="st">&quot;[</span><span class="sc">\\</span><span class="st">$]&quot;</span>))</span></code></pre></div>
</div>
<div id="renaming" class="section level2 hasAnchor" number="3.8">
<h2><span class="header-section-number">3.8</span> Renaming<a href="data-preparation.html#renaming" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="data-preparation.html#cb8-1" aria-hidden="true" tabindex="-1"></a>household <span class="ot">&lt;-</span> household <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="data-preparation.html#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">V000 =</span> HV000, <span class="at">V001 =</span> HV001, <span class="at">V002 =</span> HV002, <span class="at">V003 =</span> HV003, <span class="at">V004 =</span> HV004)</span></code></pre></div>
<p>The matching key information can be found in <code>HV000</code>, <code>HV001</code>, <code>HV0002</code>, <code>HV003</code>, <code>HV004</code>.
They are renamed to be used for joining with the individual data table.</p>
<ul>
<li>HV000 Country code and phase<br />
</li>
<li>HV001 Cluster number<br />
</li>
<li>HV002 Household number<br />
</li>
<li>HV003 Respondent’s line number (answering Household questionnaire)</li>
<li>HV004 Ultimate area unit</li>
</ul>
</div>
<div id="selection-of-the-variables-3" class="section level2 hasAnchor" number="3.9">
<h2><span class="header-section-number">3.9</span> Selection of the variables (3)<a href="data-preparation.html#selection-of-the-variables-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="data-preparation.html#cb9-1" aria-hidden="true" tabindex="-1"></a>household <span class="ot">&lt;-</span> household <span class="sc">%&gt;%</span> <span class="fu">select_if</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">is.na</span>(x)) <span class="sc">&lt;</span> <span class="fl">0.3</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>V000) <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="data-preparation.html#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>V003) <span class="co"># same country</span></span></code></pre></div>
<p>Same missing rules are applied to select the relevant variables.
We can see that 3028 columns are reduced to 142.</p>
</div>
<div id="glimpse-of-the-data-1" class="section level2 hasAnchor" number="3.10">
<h2><span class="header-section-number">3.10</span> Glimpse of the data<a href="data-preparation.html#glimpse-of-the-data-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Similarly to the individual data, only first few are presented here.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="data-preparation.html#cb10-1" aria-hidden="true" tabindex="-1"></a>info <span class="ot">&lt;-</span> <span class="fu">lapply</span>(household, <span class="cf">function</span>(x) <span class="fu">attr</span>(x, <span class="st">&quot;label&quot;</span>))</span>
<span id="cb10-2"><a href="data-preparation.html#cb10-2" aria-hidden="true" tabindex="-1"></a>house_var_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">COL =</span> <span class="fu">names</span>(info), <span class="at">DESC =</span> <span class="fu">as.character</span>(info)) </span>
<span id="cb10-3"><a href="data-preparation.html#cb10-3" aria-hidden="true" tabindex="-1"></a>house_var_tbl <span class="sc">%&gt;%</span> head <span class="sc">%&gt;%</span> pander</span></code></pre></div>
<table style="width:51%;">
<colgroup>
<col width="11%" />
<col width="40%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">COL</th>
<th align="center">DESC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">HHID</td>
<td align="center">Case Identification</td>
</tr>
<tr class="even">
<td align="center">V001</td>
<td align="center">Cluster number</td>
</tr>
<tr class="odd">
<td align="center">V002</td>
<td align="center">Household number</td>
</tr>
<tr class="even">
<td align="center">V004</td>
<td align="center">Ultimate area unit</td>
</tr>
<tr class="odd">
<td align="center">HV005</td>
<td align="center">Household sample weight (6
decimals)</td>
</tr>
<tr class="even">
<td align="center">HV006</td>
<td align="center">Month of interview</td>
</tr>
</tbody>
</table>
</div>
<div id="joining-the-individual-and-household-data" class="section level2 hasAnchor" number="3.11">
<h2><span class="header-section-number">3.11</span> Joining the individual and household data<a href="data-preparation.html#joining-the-individual-and-household-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>We combine the individual data set and household data to create
<code>dhs_expanded</code>.</li>
<li>We join the individual and household data sets by using <code>V000</code>, <code>V001</code>, <code>V0002</code>, <code>V003</code>, <code>V004</code> as key variables.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="data-preparation.html#cb11-1" aria-hidden="true" tabindex="-1"></a>dhs_expanded <span class="ot">&lt;-</span> <span class="fu">left_join</span>(indiv, household, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;V001&quot;</span>, <span class="st">&quot;V002&quot;</span>, <span class="st">&quot;V004&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="data-preparation.html#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(V001) </span></code></pre></div>
<blockquote>
<p><code>HV004</code>: Ultimate area unit is a number assigned to each sample point to identify the ultimate area units used in the collection of data. This variable is usually the same as the cluster number, but may be a sequentially numbered variable for samples with a more complicated structure.</p>
</blockquote>
</div>
<div id="data-modification" class="section level2 hasAnchor" number="3.12">
<h2><span class="header-section-number">3.12</span> Data modification<a href="data-preparation.html#data-modification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><code>V218</code> Number of living children; convert it into three categories and rename it as <code>V218R</code></li>
<li><code>V013</code>: Age in 5-year groups; convert it into three categories and rename it as <code>V013R</code></li>
</ul>
<pre><code>V218R
         0        1-2        3-4 5 and more 
         0          1          3          5 

V013R
15-24 25-34 35-49 
    1     2     3 </code></pre>
</div>
<div id="conversion" class="section level2 hasAnchor" number="3.13">
<h2><span class="header-section-number">3.13</span> Conversion<a href="data-preparation.html#conversion" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The age group variables are re-coded into a fewer categories.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="data-preparation.html#cb13-1" aria-hidden="true" tabindex="-1"></a>dhs_expanded <span class="ot">&lt;-</span> dhs_expanded <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">V013R =</span> </span>
<span id="cb13-2"><a href="data-preparation.html#cb13-2" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">ifelse</span>(V013 <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span>, </span>
<span id="cb13-3"><a href="data-preparation.html#cb13-3" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">ifelse</span>(V013 <span class="sc">%in%</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, </span>
<span id="cb13-4"><a href="data-preparation.html#cb13-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(V013 <span class="sc">&gt;</span> <span class="dv">4</span>, <span class="dv">3</span>, V013))))</span>
<span id="cb13-5"><a href="data-preparation.html#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="data-preparation.html#cb13-6" aria-hidden="true" tabindex="-1"></a>dhs_expanded <span class="ot">&lt;-</span> dhs_expanded <span class="sc">%&gt;%</span> </span>
<span id="cb13-7"><a href="data-preparation.html#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">V218R =</span> </span>
<span id="cb13-8"><a href="data-preparation.html#cb13-8" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(V218 <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(V218 <span class="sc">==</span> <span class="dv">1</span><span class="sc">|</span>V218 <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">1</span>, </span>
<span id="cb13-9"><a href="data-preparation.html#cb13-9" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(V218 <span class="sc">==</span><span class="dv">3</span><span class="sc">|</span>V218 <span class="sc">==</span><span class="dv">4</span>, <span class="dv">3</span>, </span>
<span id="cb13-10"><a href="data-preparation.html#cb13-10" aria-hidden="true" tabindex="-1"></a>                                              <span class="fu">ifelse</span>(V218 <span class="sc">&gt;=</span><span class="dv">5</span>, <span class="dv">5</span>, V218)))))</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="data-preparation.html#cb14-1" aria-hidden="true" tabindex="-1"></a>dhs_expanded <span class="ot">&lt;-</span> dhs_expanded <span class="sc">%&gt;%</span> <span class="fu">select_if</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">is.na</span>(x)) <span class="sc">&lt;</span> <span class="fl">0.9</span>) <span class="co"># remove if more than 10% missing</span></span></code></pre></div>
<p>Additional steps followed to remove columns with too much missing info.</p>
</div>
<div id="defining-the-target-variables" class="section level2 hasAnchor" number="3.14">
<h2><span class="header-section-number">3.14</span> Defining the target variables<a href="data-preparation.html#defining-the-target-variables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Contraceptive prevalence rate (CPR) - using <code>V313</code>: combine 1, 2, 3 as “Yes”; 0 as “No.</li>
<li>Modern contraceptive prevalence rate (CPRm) - using <code>V313</code>: combine 0, 1, 2, 3 as “No”; 3 as “Yes”.</li>
<li>Unmet need for family planning rate (UNR) - using <code>V626</code>: combining 1, 2 as “Yes” (unmet need for family planning); combining all other answers as “No”.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="data-preparation.html#cb15-1" aria-hidden="true" tabindex="-1"></a>dhs_reduced <span class="ot">&lt;-</span> </span>
<span id="cb15-2"><a href="data-preparation.html#cb15-2" aria-hidden="true" tabindex="-1"></a>dhs_expanded <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="data-preparation.html#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(V013R, V106, V218R, V025, V120, V127, V128, V128, V129, V113, </span>
<span id="cb15-4"><a href="data-preparation.html#cb15-4" aria-hidden="true" tabindex="-1"></a>         V001, V005, <span class="co"># survey info part</span></span>
<span id="cb15-5"><a href="data-preparation.html#cb15-5" aria-hidden="true" tabindex="-1"></a>                   V119,</span>
<span id="cb15-6"><a href="data-preparation.html#cb15-6" aria-hidden="true" tabindex="-1"></a>                   HV206, </span>
<span id="cb15-7"><a href="data-preparation.html#cb15-7" aria-hidden="true" tabindex="-1"></a>                   V130, </span>
<span id="cb15-8"><a href="data-preparation.html#cb15-8" aria-hidden="true" tabindex="-1"></a>                   V116,</span>
<span id="cb15-9"><a href="data-preparation.html#cb15-9" aria-hidden="true" tabindex="-1"></a>                   V151,</span>
<span id="cb15-10"><a href="data-preparation.html#cb15-10" aria-hidden="true" tabindex="-1"></a>                   V150, </span>
<span id="cb15-11"><a href="data-preparation.html#cb15-11" aria-hidden="true" tabindex="-1"></a>                   V626, V313) <span class="sc">%&gt;%</span> </span>
<span id="cb15-12"><a href="data-preparation.html#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CPR =</span> <span class="fu">ifelse</span>(V313 <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-13"><a href="data-preparation.html#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CPRm =</span> <span class="fu">ifelse</span>(V313 <span class="sc">==</span> <span class="dv">3</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-14"><a href="data-preparation.html#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">UNR =</span> <span class="fu">ifelse</span>(V626 <span class="sc">==</span> <span class="dv">1</span><span class="sc">|</span>V626 <span class="sc">==</span> <span class="dv">2</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-15"><a href="data-preparation.html#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>V313, <span class="sc">-</span>V626)</span>
<span id="cb15-16"><a href="data-preparation.html#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="data-preparation.html#cb15-17" aria-hidden="true" tabindex="-1"></a>dhs_reduced  <span class="ot">&lt;-</span> dhs_reduced <span class="sc">%&gt;%</span> </span>
<span id="cb15-18"><a href="data-preparation.html#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(as_factor) <span class="sc">%&gt;%</span> </span>
<span id="cb15-19"><a href="data-preparation.html#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">V218R =</span> <span class="fu">ifelse</span>(V218R <span class="sc">==</span> <span class="st">&quot;5 and more&quot;</span><span class="sc">|</span>V218R <span class="sc">==</span> <span class="st">&quot;3-4&quot;</span>,</span>
<span id="cb15-20"><a href="data-preparation.html#cb15-20" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;3 or more&quot;</span>, V218R)) </span>
<span id="cb15-21"><a href="data-preparation.html#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="data-preparation.html#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(dhs_reduced<span class="sc">$</span>V218R, <span class="st">&quot;label&quot;</span>) <span class="ot">&lt;-</span> <span class="fu">attr</span>(dhs_expanded<span class="sc">$</span>V218, <span class="st">&quot;label&quot;</span>)</span></code></pre></div>
</div>
<div id="quick-screeing-of-key-variables" class="section level2 hasAnchor" number="3.15">
<h2><span class="header-section-number">3.15</span> Quick screeing of key variables<a href="data-preparation.html#quick-screeing-of-key-variables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>This step is quickly screen the important variables found based on a machine learning based method.</li>
<li>The example below shows the case where <code>V013R, V106, V218R, V025, V120, V127, V128, V128, V129, V113, V119, HV206, V130, V116, V151, V150</code> are used as the candidates, and choose the seemingly important six variables among them.</li>
<li>To see the detail about the metric, see <a href="https://en.wikipedia.org/wiki/Random_forest#Variable_importance">this</a>.</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="data-preparation.html#cb16-1" aria-hidden="true" tabindex="-1"></a>temp_set <span class="ot">&lt;-</span> dhs_reduced <span class="sc">%&gt;%</span> na.omit</span>
<span id="cb16-2"><a href="data-preparation.html#cb16-2" aria-hidden="true" tabindex="-1"></a>temp_rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(CPR <span class="sc">~</span> V013R <span class="sc">+</span> V106 <span class="sc">+</span> V218R <span class="sc">+</span> V025 <span class="sc">+</span> V120 <span class="sc">+</span> V127 <span class="sc">+</span> V128 <span class="sc">+</span> V128 <span class="sc">+</span> V129 <span class="sc">+</span> V113 <span class="sc">+</span> V119 <span class="sc">+</span> </span>
<span id="cb16-3"><a href="data-preparation.html#cb16-3" aria-hidden="true" tabindex="-1"></a>                          HV206 <span class="sc">+</span> V130 <span class="sc">+</span> V116 <span class="sc">+</span> V151 <span class="sc">+</span> V150, <span class="at">data =</span> temp_set)</span>
<span id="cb16-4"><a href="data-preparation.html#cb16-4" aria-hidden="true" tabindex="-1"></a>imp_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">imp =</span> <span class="fu">as.numeric</span>(<span class="fu">importance</span>(temp_rf)), <span class="at">key =</span> <span class="fu">rownames</span>(<span class="fu">importance</span>(temp_rf))) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">q =</span> <span class="fu">rank</span>(<span class="sc">-</span>imp))</span>
<span id="cb16-5"><a href="data-preparation.html#cb16-5" aria-hidden="true" tabindex="-1"></a>selected_06 <span class="ot">&lt;-</span> imp_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(q  <span class="sc">&lt;=</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="sc">-</span>imp)</span>
<span id="cb16-6"><a href="data-preparation.html#cb16-6" aria-hidden="true" tabindex="-1"></a>info_v <span class="ot">&lt;-</span> <span class="fu">lapply</span>(temp_set, <span class="cf">function</span>(x) <span class="fu">attr</span>(x, <span class="st">&quot;label&quot;</span>)) <span class="sc">%&gt;%</span> bind_rows <span class="sc">%&gt;%</span> gather</span>
<span id="cb16-7"><a href="data-preparation.html#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(selected_06, info_v, <span class="at">by =</span> <span class="st">&quot;key&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>imp) <span class="sc">%&gt;%</span> <span class="fu">pander</span>()</span></code></pre></div>
<table style="width:56%;">
<colgroup>
<col width="11%" />
<col width="5%" />
<col width="38%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">key</th>
<th align="center">q</th>
<th align="center">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">V113</td>
<td align="center">1</td>
<td align="center">Source of drinking water</td>
</tr>
<tr class="even">
<td align="center">V130</td>
<td align="center">2</td>
<td align="center">Religion</td>
</tr>
<tr class="odd">
<td align="center">V128</td>
<td align="center">3</td>
<td align="center">Main wall material</td>
</tr>
<tr class="even">
<td align="center">V116</td>
<td align="center">4</td>
<td align="center">Type of toilet facility</td>
</tr>
<tr class="odd">
<td align="center">V127</td>
<td align="center">5</td>
<td align="center">Main floor material</td>
</tr>
<tr class="even">
<td align="center">V218R</td>
<td align="center">6</td>
<td align="center">Number of living children</td>
</tr>
</tbody>
</table>
</div>
<div id="additional-steps-to-simplify-the-data-1" class="section level2 hasAnchor" number="3.16">
<h2><span class="header-section-number">3.16</span> Additional steps to simplify the data (1)<a href="data-preparation.html#additional-steps-to-simplify-the-data-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Many problems are caused when we carry variables with too many categories, where many categories have few counts.</li>
<li><code>fct_lump_prop</code> combines levels that appear less than 10 % and create a new category named “Other”.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="data-preparation.html#cb17-1" aria-hidden="true" tabindex="-1"></a>target <span class="ot">&lt;-</span> selected_06<span class="sc">$</span>key</span>
<span id="cb17-2"><a href="data-preparation.html#cb17-2" aria-hidden="true" tabindex="-1"></a>reduced_tbl <span class="ot">&lt;-</span> </span>
<span id="cb17-3"><a href="data-preparation.html#cb17-3" aria-hidden="true" tabindex="-1"></a>  temp_set <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="data-preparation.html#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(<span class="cf">function</span>(x) <span class="fu">n_distinct</span>(x) <span class="sc">&lt;</span> <span class="dv">20</span>, as.factor) <span class="sc">%&gt;%</span> </span>
<span id="cb17-5"><a href="data-preparation.html#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">all_of</span>(target), <span class="cf">function</span>(x) <span class="fu">fct_lump_prop</span>(x, <span class="fl">0.1</span>, <span class="at">other_level =</span> <span class="st">&quot;Other&quot;</span>))  </span></code></pre></div>
</div>
<div id="additional-steps-to-simplify-the-data-2" class="section level2 hasAnchor" number="3.17">
<h2><span class="header-section-number">3.17</span> Additional steps to simplify the data (2)<a href="data-preparation.html#additional-steps-to-simplify-the-data-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><code>reduced_tbl</code> now has columns with fewer categories after lumping levels with less than 10% proportion.</li>
<li>As a comparison,</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="data-preparation.html#cb18-1" aria-hidden="true" tabindex="-1"></a>temp_set <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(V130) <span class="sc">%&gt;%</span> tally <span class="sc">%&gt;%</span> pander</span></code></pre></div>
<table style="width:47%;">
<colgroup>
<col width="37%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">V130</th>
<th align="center">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Catholic</td>
<td align="center">1341</td>
</tr>
<tr class="even">
<td align="center">Anglican</td>
<td align="center">72</td>
</tr>
<tr class="odd">
<td align="center">Methodist</td>
<td align="center">547</td>
</tr>
<tr class="even">
<td align="center">Presbyterian</td>
<td align="center">513</td>
</tr>
<tr class="odd">
<td align="center">Pentecostal/charismatic</td>
<td align="center">3456</td>
</tr>
<tr class="even">
<td align="center">Other Christian</td>
<td align="center">1239</td>
</tr>
<tr class="odd">
<td align="center">Islam</td>
<td align="center">1726</td>
</tr>
<tr class="even">
<td align="center">Traditional/spiritualist</td>
<td align="center">226</td>
</tr>
<tr class="odd">
<td align="center">No religion</td>
<td align="center">273</td>
</tr>
<tr class="even">
<td align="center">Other</td>
<td align="center">1</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="data-preparation.html#cb19-1" aria-hidden="true" tabindex="-1"></a>reduced_tbl <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(V130) <span class="sc">%&gt;%</span> tally <span class="sc">%&gt;%</span> pander</span></code></pre></div>
<table style="width:46%;">
<colgroup>
<col width="36%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">V130</th>
<th align="center">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Catholic</td>
<td align="center">1341</td>
</tr>
<tr class="even">
<td align="center">Pentecostal/charismatic</td>
<td align="center">3456</td>
</tr>
<tr class="odd">
<td align="center">Other Christian</td>
<td align="center">1239</td>
</tr>
<tr class="even">
<td align="center">Islam</td>
<td align="center">1726</td>
</tr>
<tr class="odd">
<td align="center">Other</td>
<td align="center">1632</td>
</tr>
</tbody>
</table>
<ul>
<li>This “lumping” process improves overall model fitting by removing the (near-) singularity of the model matrix.</li>
<li>The model selection step is automated in the code below.</li>
</ul>
</div>
<div id="automatic-model-fitting" class="section level2 hasAnchor" number="3.18">
<h2><span class="header-section-number">3.18</span> Automatic Model fitting<a href="data-preparation.html#automatic-model-fitting" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="data-preparation.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># automation of this needs a carefully examined set of the variables</span></span>
<span id="cb20-2"><a href="data-preparation.html#cb20-2" aria-hidden="true" tabindex="-1"></a>fe_form <span class="ot">&lt;-</span> <span class="fu">paste</span>(selected_06<span class="sc">$</span>key, <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>)</span>
<span id="cb20-3"><a href="data-preparation.html#cb20-3" aria-hidden="true" tabindex="-1"></a>full_form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">&quot;CPR ~ &quot;</span>, fe_form, <span class="st">&quot;+ (1|V001)&quot;</span>)) </span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="data-preparation.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># full model (with all data)</span></span>
<span id="cb21-2"><a href="data-preparation.html#cb21-2" aria-hidden="true" tabindex="-1"></a>model_out <span class="ot">&lt;-</span> <span class="fu">glmer</span>(<span class="at">formula =</span> full_form, <span class="at">data =</span> reduced_tbl, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">&quot;logit&quot;</span>))</span></code></pre></div>
<ul>
<li>We use the selected 6 variables from the screening process.</li>
<li>It automatically writes a formula taking <code>CPR</code> as our target indicator, and the survey cluster as
a random effect.</li>
<li>To see what’s the formula, see the following output of <code>full_form</code> (“full” formula including fixed effects and random effect).</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="data-preparation.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(full_form)</span></code></pre></div>
<pre><code>## CPR ~ V113 + V130 + V128 + V116 + V127 + V218R + (1 | V001)</code></pre>
<ul>
<li>In this example, is used in <code>glmer</code>, generalized linear mixed effects model. Users can use this in the later part as a reference.</li>
</ul>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="spatial-data-loading.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": false,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
